@{
    var message = TempData["AlertMessage"] ?? string.Empty;
}
@model eHR.PMS.Web.Models.DTO.AppraisalPage
@{int index = 0; int kpiindex = 0; int commentsindex = 0;}

 <div class="frame">
           <ul id="sectionlist" class="nav nav-tabs">
            @{if (!eHR.PMS.Lib.Utility.Common.IsNullOrEmptyList(Model.Sections))
              {
                  bool flag = false;
                  foreach (eHR.PMS.Model.DTO.Master.Section sc in Model.Sections)
                  {
                      if (sc.Name.Replace(" ", "") == ViewContext.RouteData.Values["Action"].ToString() || Model.ViewOnly)
                      {
                          flag = true;
                          <li class="active"><a sectionid="@sc.Id" href="@(Url.Content("~/Stage1/"))@(sc.Name.Replace(" ", ""))/@(Model.CurrentTaskId)/@(Model.Appraisal.Id)#" >@sc.Name</a><input type="hidden" value="@sc.Id" name="SectionID" /></li>  
                      }
                      else
                      {
                          if (flag)
                          {
                                    <li><a sectionid="@sc.Id" class="Next" href="#" >@sc.Name</a></li>
                          }
                          else
                          {
                                <li><a sectionid="@sc.Id" href="@(Url.Content("~/Stage1/"))@(sc.Name.Replace(" ", ""))/@(Model.CurrentTaskId)/@(Model.Appraisal.Id)#" >@sc.Name</a></li>
                          }
                      }
                  }
              }
            }  
        </ul>
        <div  class="row" style="padding:10px;">
          <div class="col-md-10">
            <div id="Description" class="alert alert-success">
            <h4>ACR Core Values :</h4>
            <p>
                The ACR Core Values guides our behaviours, the way we conduct business and how we treat our clients and colleagues. 
                Living the values is essential to creating and reinforcing our corporate values.<br />
                All Core Values (RIPPLES) must be evaluated for the year.<br />
            </p>
            <br />
            <h4>Core Value Ratings :</h4>
            <p>
                <img alt="ACR Core Value Rating Descriptors" src="@(Url.Content("~/Content/img/pms_corevalue_rating_description.jpg"))" />
            </p>
            </div>
           <form action="@(Url.Content("~/Stage1/CoreValues/"))@Model.CurrentTaskId/@Model.Appraisal.Id" method="post">
            <input type="hidden" name="deleteKPIid" id="deleteKPIid" />
          @foreach (eHR.PMS.Model.DTO.Master.Block kpinfo in Model.CurrentSection.Blocks)
          {
               
              <div id="@(kpinfo.Name.Split('/')[0])" class="panel-group" style="margin-bottom:10px;">
            <div class="panel panel-default" style="overflow: visible;">
                <div class="panel-heading">
                  <h4 class="panel-title">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#Financials" href="#collapse(@index)">
                      @(kpinfo.Name)
                    </a>
                  </h4>
                  <h6><span class="help-block">@(kpinfo.Description)</span></h6>
                </div>
                <div id="collapse(@index)" class="panel-collapse collapse in">
                  <div class="panel-body">
                  
                    <div blockid="@(kpinfo.Id)" class="tablediv" style="display:none;">
                        
                        <table class="table">
                            <thead class="">
                                <tr class="thead-color">
                                    <th></th>
                                    <th style="width:30%">Core Value Competency</th>
                                    <th style="width:35%">Performance Target</th>                                   
                                    <th style="width:30%"></th>
                                </tr>
                            </thead>
                            <tbody class="KPItbody">
                                @{if (!eHR.PMS.Lib.Utility.Common.IsNullOrEmptyList(Model.Appraisal.CoreValues))
                                  {
                                      IEnumerable<eHR.PMS.Model.DTO.Appraisal.CoreValue> list = Model.Appraisal.CoreValues.Where(rec => rec.Block.Id == kpinfo.Id);
                                      foreach (eHR.PMS.Model.DTO.Appraisal.CoreValue kpi in list)
                                      {
                                            <tr>
                                                <td><input type="hidden" class="KPIID" value="@(kpi.Id)" /></td>
                                                <td>@(kpi.CoreValueCompetency.Name)</td>
                                                <td>@(kpi.Target)</td>
                                                <td style="display:none;">
                                                <input type="text" class="KPIforDatabase" name="KPIforDatabase@(kpiindex++)Block@(kpinfo.Id)" value="@(kpi.Id)^&*@(kpi.Appraisal.Id)^&*@(Model.CurrentSection.Id)^&*@(kpi.Block.Id)^&*@(kpi.CoreValueCompetency.Id)^&*@(kpi.Target)^&*ONERECORDENDED"/>
                                                @{if (!eHR.PMS.Lib.Utility.Common.IsNullOrEmptyList(kpi.Comments))
                                                  {
                                                    <div class="Comments">
                                                            <div style="width:500px;">                                                   
                                                            <ul class="list-group">
                                                          @foreach (eHR.PMS.Model.DTO.Appraisal.CoreValueComment comment in kpi.Comments)
                                                          {
                                                             <li class="list-group-item">
                                                             <span class="badge">By @(comment.Commentor.PreferredName) on @(Convert.ToDateTime(comment.CommentedTimestamp).ToString("hh:mm tt,dd-MMM-yyyy"))</span>                                                                                                                           
                                                             <br />
                                                             <p style="word-wrap:break-word;">@(comment.Comments)</p>
                                                              </li>
                                                          }
                                                            </ul> 
                                                            </div>                                                  
                                                     
                                                   </div>
                                                  }
                                                  else
                                                  {
                                                    <div class="Comments"></div>
                                                  }
                                                  }

                                                </td>
                                                <td align="right">
                                                 @{ if (!Model.ViewOnly)
                                                    {
                                                         <a href="javascript:void(0)" class="EditKPI btn btn-info btn-xs"><i class="glyphicon glyphicon-wrench"></i> Edit</a>
                                                         <a href="javascript:void(0)" class="RemoveKPI btn btn-danger btn-xs"><i class="glyphicon glyphicon-trash"></i> Remove</a>
                                                    
                                                    }
                                                  }
                                                    <a commentsid="@(kpinfo.Id)@(commentsindex++)" href="javascript:void(0)" class="ViewKpiComments btn btn-warning btn-xs" ><i class="glyphicon glyphicon-pencil"></i> View Comments</a>                                                     
                                                </td>
                                            </tr>
                                      }
                                  }
                                }
                            </tbody>
                         </table>
                    </div>
                    @{ if (!Model.ViewOnly)
                       {
                    <div class="row">
                        <div class="col-md-6">
                            <span class="label label-info">Core Competency:</span>
                            <br />
                            <select class="selectpicker show-tick">
                                @{ if (!eHR.PMS.Lib.Utility.Common.IsNullOrEmptyList(Model.CoreValueCompetencies))
                                   {
                                       IEnumerable<eHR.PMS.Model.DTO.GradeCompetency> lst_competencies = Model.CoreValueCompetencies.Where(rec => rec.Block.Id == kpinfo.Id);
                                       foreach (eHR.PMS.Model.DTO.GradeCompetency c in lst_competencies)
                                       { 
                                            <option value="@c.CoreValueCompetencyId">@c.Name</option>
                                       }
                                   }

                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <span class="label label-info">Performance Target:</span>
                            <br />
                             <textarea class="corevaluetext idleField" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="Adddiv" style="margin-top:20px;">
                      <button type="button" class="AddKPIItem btn btn-success btn-xs"><i class="glyphicon glyphicon-plus"></i> Add</button>                               
                    </div>
                    <div class="Updatediv" style="display:none;">
                      <button type="button" class="UpdateKPIItem btn btn-primary btn-xs"><i class="glyphicon glyphicon-ok"></i> Update</button>
                      <button type="button" class="CancelKPIItem btn btn-xs"><i class="glyphicon glyphicon-remove"></i> Cancel</button>
                    </div> 
                       }
                     }           
                  </div>
                </div>
            </div>
           </div> 
                                      index++;
          }
           
           <div id="buttongroup" style="text-align: center;">
             <div style="float:left;">
                 <a href="@Url.Content("~/Stage1/KeyPerformanceIndicators/")@(Model.CurrentTaskId)/@(Model.Appraisal.Id)" class="btn btn-warning btn-xs"><i class="glyphicon glyphicon-hand-left"></i> Prev</a>
                 @{if(!Model.ViewOnly)
                   {
                        <button type="button" id="stage1kpisubmit" class="btn btn-warning btn-xs">Next <i class="glyphicon glyphicon-hand-right"></i></button>
                        <!--<a href="@(Url.Content("~/Stage1/PerformanceCoachingandReview/"))@Model.CurrentTaskId/@Model.Appraisal.Id" class="btn btn-warning btn-xs">Skip <i class="glyphicon glyphicon-share-alt"></i></a>-->
 
                   }
                   else
                   {
                        <a href="@(Url.Content("Stage1/PerformanceCoachingandReview/"))@Model.CurrentTaskId/@Model.Appraisal.Id" class="btn btn-warning btn-xs"><i class="glyphicon glyphicon-hand-right"></i> Next</a>
                   }
                  }
             </div>
             <!--<button type="button" id="stage1kpisubmit" class="btn btn-primary"><i class="glyphicon glyphicon-floppy-saved"></i> Submit</button>
             -->
             <div style="float:right;">           
                    @{if (!Model.ViewOnly)
                      { 
                            <button type="button" data-loading-text="Saving...." id="stage1kpisave" class="btn btn-success btn-xs"><i class="glyphicon glyphicon-save"></i> Save</button>
                            <button type="button" class="btn btn-danger btn-xs" id="btn_appraisal_cancel"><i class="glyphicon glyphicon-floppy-remove"></i> Cancel</button>
                      }
                      else
                      {
                            <a href="@(Url.Content("~/"))" class="btn btn-danger btn-xs"><i class="glyphicon glyphicon-floppy-remove"></i> Cancel</a>
                      }
                      }            
             </div>
            </div>


            <!--pop up info for submit -->
            <div style="top:50%;" class="modal fade" id="SubmitInfoModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
              <div class="modal-dialog" style="text-align:center;">
                <div  class="modal-content">
                  <div class="modal-body" style="padding-bottom:0px;">
                        <div class="alert alert-warning alert-dismissable">
                          <strong>Information entered for Core Values will be saved. Do you want to continue?</strong>
                        </div>
                  </div>
                  <div class="modal-footer">
                    <button type="submit" data-loading-text="Submit...." class="btn btn-primary">OK</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
                  </div>

                </div><!-- /.modal-content -->
              </div><!-- /.modal-dialog -->
            </div><!-- /.modal -->

            <!--pop up info for cancel -->
            <div style="top:50%;" class="modal fade" id="CancelInfoModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
              <div class="modal-dialog" style="text-align:center;">
                <div  class="modal-content">
                  <div class="modal-body" style="padding-bottom:0px;">
                    <div class="alert alert-warning alert-dismissable">
                        <strong>@(eHR.PMS.Web.Resources.Resource.MSG_CANCEL)</strong>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" id="btn_cancel_modal_ok" class="btn btn-primary">Yes</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">No</button>
                  </div>
                </div><!-- /.modal-content -->
              </div><!-- /.modal-dialog -->
            </div><!-- /.modal -->
           </form>
          </div>
          <div id="sidenav" data-spy="affix" class="col-md-2" style="right:2%;">
                <ul class="nav nav-pills nav-stacked" style="border:1px solid #E1E1E8">
                  <li><h5 style="padding:10px 15px;">Quick link</h5></li>
                  <li class="divider"></li>
                  <li><a href="#header">Top</a></li>
                  @{foreach (eHR.PMS.Model.DTO.Master.Block kpinfo in Model.CurrentSection.Blocks)
                    {
                        <li><a href="#@(kpinfo.Name.Split('/')[0])">@kpinfo.Name</a></li> 
                    }  
                   }
                </ul>
                <ul class="nav nav-pills nav-stacked autosaveloading" id="autosaveloading" style="border:1px solid #E1E1E8;margin-top:10px;text-align:center; display:none;">
                    <li><h6><img alt="" src="@(Url.Content("~/Content/img/ajax-loader.gif"))" />Autosaving....</h6></li>
                </ul>
         </div>
        </div>
    </div>

    

    <!--pop up info for ajaxsave -->
    <div style="top:50%;" class="modal fade" id="InfoModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
      <div class="modal-dialog" style="text-align:center;">
        <div id="loadingcontent" class="modal-content">
          <div class="modal-body">
                <img alt="" src="@(Url.Content("~/Content/img/ajax-loader.gif"))" />
          </div>
        </div><!-- /.modal-content -->
        <div id="resultcontent" class="modal-content" style="display:none;">
          <div class="modal-body" style="padding-bottom:0px;">
                <div class="alert alert-success alert-dismissable">
                  <strong>@(eHR.PMS.Web.Resources.Resource.MSG_SAVE_SUCCESS_CORE_VALUE)</strong>
                </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
          </div>

        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    
    <!--pop up info for redirect-->
    <div style="top:50%;" class="modal fade" id="RedirectModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static">
      <div class="modal-dialog" style="text-align:center;">
        <div id="submitcontent" class="modal-content">
          <div class="modal-body" style="padding-bottom:0px;">
                <div class="alert alert-success alert-dismissable">
                  <strong>@message</strong>
                </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
          </div>

        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->


    <script type="text/javascript">
        var message = '@message';

        var savefunction = function () {
            var KPIArray = new Array();
            $.each($(".KPIforDatabase"), function () {
                KPIArray.push($(this).val());
            });
            $.ajax({
                url: "@(Url.Content("~/Stage1/CoreValuesSave"))",
                type: "POST",
                dataType: "Json",
                data: { "KPIForDatabase": JSON.stringify(KPIArray), "DeleteKPI": $("#deleteKPIid").val().substring(1) },
                beforeSend: function () {
                    //$("#stage1kpisave").button('loading');
                    //$("#buttongroup").showLoading();
                    $('#resultcontent').hide();
                    $('#loadingcontent').show();
                    $('#InfoModal').modal();
                },
                success: function (data) {
                    $("#stage1kpisave").button('reset');
                    $('#loadingcontent').hide();
                    $('#resultcontent').show();
                    //$('#InfoModal').modal();
                }
            });
        };
        var autosavefunction = function () {
            var KPIArray = new Array();
            $.each($(".KPIforDatabase"), function () {
                KPIArray.push($(this).val());
            });
            $.ajax({
                url: "@(Url.Content("~/Stage1/CoreValuesSave"))",
                type: "POST",
                dataType: "Json",
                data: { "KPIForDatabase": JSON.stringify(KPIArray), "DeleteKPI": $("#deleteKPIid").val().substring(1) },
                beforeSend: function () {
                    $("#autosaveloading").show('slow');
                    $("#stage1kpisave").attr("disabled", true);
                },
                success: function (data) {
                    $("#autosaveloading").hide('slow');
                    $("#stage1kpisave").attr("disabled", false);
                }
            });
        };
        $(function () {
            //if (message)
            //    $('#RedirectModal').modal();
            $('body').scrollspy({ target: '#sidenav' });
            $('.selectpicker').selectpicker();
            $('button[data-loading-text]').click(function () {
                $(this).button('loading');
            });
            $.each($(".KPIID"), function () {
                $(this).parent().parent().parent().parent().parent().show();
            });
            $(".Next").click(function () {
                $("#stage1kpisubmit").trigger('click');
            });
            var editbuttonobject = new Object();
            var AdddivforEdit = new Object();
            var UpdatedivforEdit = new Object();
            var KPItextHidSelectforEdit = new Object();
            var KPItextSelectEdit = new Object();
            //added

            var PTtextforEdit = new Object();
            $(".panel-body").on('click', '.EditKPI', function () {
                $(".EditKPI").removeClass("disabled");
                $(".EditKPI").next().removeClass("disabled");
                editbuttonobject = $(this);
                var div = $(this).parent().parent().parent().parent().parent().parent();
                Adddiv = div.find(".Adddiv");
                //added
                AdddivforEdit = div.find(".Adddiv");
                UpdatedivforEdit = div.find(".Updatediv");

                Updatediv = div.find(".Updatediv");
                KPItextHidSelectforEdit = div.parent().find(".bootstrap-select");
                KPItextSelectEdit = div.find(".selectpicker");
                PTtextforEdit = div.find(".PTtext");
                KPItextHidSelectforEdit.find('.filter-option').text($(this).parent().prev().prev().prev().text());
                KPItextSelectEdit.val($(this).parent().prev().prev().prev().prev().text());
                PTtextforEdit.val($(this).parent().prev().prev().text());
                $(this).addClass("disabled");
                $(this).next().addClass("disabled");
                AdddivforEdit.hide("slow");
                UpdatedivforEdit.show("slow");
                //KPItext.trigger("focus");
            });
            $(".panel-body").on("click", ".RemoveKPI", function () {
                var obj = $(this).parent().parent().find(".KPIID");
                if (obj.val() != "NewKPI") {
                    var oldvalue = $("#deleteKPIid").val();
                    $("#deleteKPIid").val(oldvalue + "-" + obj.val());
                }
                $(this).parent().parent().remove();
            });

            var oddClick = true;
            var oldComments = 0;
            var newComments = 0;
            $(".panel-body").on('click', '.ViewKpiComments', function () {
                if ($(".popover").length == 0) oddClick = true;
                if (oddClick) {
                    oddClick = !oddClick;
                    oldComments = newComments = $(this).attr("commentsid");
                    $(this).popover({
                        title: 'Comments',
                        placement: 'top',
                        html: 'true',
                        content: function () {
                            var content = $(this).parent().parent().find(".Comments").html();
                            return (content != "" ? content : "There is no Comments");
                        }
                    });
                    $(this).popover('show');
                }
                else {
                    newComments = $(this).attr("commentsid");
                    if (oldComments != newComments) {
                        oldComments = $(this).attr("commentsid");
                        $(".ViewKpiComments").popover('destroy');
                        $(this).popover({
                            title: 'Comments',
                            placement: 'top',
                            html: 'true',
                            content: function () {
                                var content = $(this).parent().parent().find(".Comments").html();
                                return (content != "" ? content : "There is no Comments");
                            }
                        });
                        $(this).popover('show');
                    }
                    else {
                        oddClick = !oddClick;
                        $(this).popover('destroy');
                    }
                }

            });
            $(".panel-body").on('click', '.UpdateKPIItem', function () {
            //aaaa
                editbuttonobject.parent().prev().prev().prev().text(KPItextSelectForEdit.find("option:selected").text());
                editbuttonobject.parent().prev().prev().prev().prev().text(KPItextSelect.val());
                editbuttonobject.parent().prev().prev().text(PTtext.text());
                var oldhidValue = editbuttonobject.parent().prev().find('.KPIforDatabase').val();
                var tempArray = oldhidValue.split("^&*");
                editbuttonobject.parent().prev().find('.KPIforDatabase').val([tempArray[0], '^&*', tempArray[1], '^&*', tempArray[2], '^&*', tempArray[3], '^&*', KPItextSelect.val(), '^&*', PTtext.val(), '^&*ONERECORDENDED'].join(''));
                editbuttonobject.removeClass("disabled");
                editbuttonobject.next().removeClass("disabled");
                Updatediv.hide("slow");
                Adddiv.show("slow");
            });
            $(".panel-body").on('click', '.CancelKPIItem', function () {
                editbuttonobject.removeClass("disabled");
                editbuttonobject.next().removeClass("disabled");
                Updatediv.hide("slow");
                Adddiv.show("slow");
            });
            $(".AddKPIItem").click(function () {
                var KPItextSelect = $(this).parent().parent().parent().find(".selectpicker");
                var KPItextHidSelect = $(this).parent().parent().parent().find(".bootstrap-select");
                var PTtext = $(this).parent().parent().parent().find(".corevaluetext");
                
                if ($.trim(PTtext.val()) == "") {
                    PTtext.addClass("warningclass");
                    return false;
                }

                var Adddiv = $(this).parent();
                var Updatediv = $(this).parent().next();
                var KPINumforThisSection = $(this).parent().parent().find(".KPItbody tr").length;
                var KPItbody = $(this).parent().parent().parent().find(".KPItbody");
                var tablediv = $(this).parent().parent().parent().find(".tablediv");
                var blockid = tablediv.attr("blockid");
                var apprid = '@(Model.Appraisal.Id)';
                var sectionid = $("#sectionlist li.active a").attr("sectionid");
                var html = ['<tr><td><input type="hidden" class="KPIID" value="NewKPI" /></td><td style="display:none">', KPItextSelect.val(), '</td><td>', KPItextSelect.find("option:selected").text(), '</td><td>', PTtext.val(), '</td><td style="display:none;"><input type="text" class="KPIforDatabase" name="KPIforDatabase', KPINumforThisSection, 'Block', blockid, '"value="NewKPI^&*', apprid, '^&*', sectionid, '^&*', blockid, '^&*', KPItextSelect.val(), "^&*", PTtext.val(), '^&*ONERECORDENDED"/><td align="right"><a href="javascript:void(0)" class="EditKPI btn btn-info btn-xs"><i class="glyphicon glyphicon-wrench"></i> Edit</a> <a href="javascript:void(0)" class="RemoveKPI btn btn-danger btn-xs"><i class="glyphicon glyphicon-trash"></i> Remove</a> <a href="javascript:void(0)" class="ViewKpiComments btn btn-warning btn-xs disabled"><i class="glyphicon glyphicon-pencil"></i> View Comments</a></td></tr>'].join('');
                $(html).appendTo(KPItbody);


                if (tablediv.is(":hidden")) {
                    tablediv.show("slow");
                }
                //resetting input box values
                PTtext.val("");
            });
            $("#stage1kpisubmit").click(function () {
               //$('#SubmitInfoModal').modal();
                $("form").submit();
            });
            $("#stage1kpisave").click(savefunction);
            $("#btn_appraisal_cancel").click(function () {
                $('#CancelInfoModal').modal();
            });

            $("#btn_cancel_modal_ok").click(function () {
                window.location.href("@(Url.Content("~/"))");
            });
        });
        setInterval(autosavefunction, 600000); 
    </script>
